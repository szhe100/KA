select h.rec_id,b.dtl_id,a.bod_id,a.carry_dt,a.bod_type_id,bod_type='分销采购',  a.bod_cd,b.bod_cd1,b.bod_cd2,b.bod_cd3,a.bod_desc,a.bod_desc1,a.broker_id,broker=dbo.fn_staff_name(a.broker_id),  agent_id=case when h.agent_id>0 then h.agent_id else a.agent_id end,  agent=f.mate_name,stoppay=isnull(f.stoppay,0),	dist1=dbo.fn_getdistrictlevel (a.district_id,1),	dist2=dbo.fn_getdistrictlevel (a.district_id,2), level1=dbo.fn_obj_desc(k.level_id1),creater=d.zname,a.dst_id,e.mate_name,m.med_code,m.med_name,m.specifi,m.pdt_place,med_unit=dbo.fn_obj_desc(m.unit_id),m.type_id1,b.bat_cd, z.ckd_amot,y.ckd_amot1,a.ckd_amot2,y.ckd_amot2a,h.ckd_amot3, b.qty,b.price,b.amot,b.amot2,b.price1,x.price10, c.type_id,c.type_id2,c.rate,c.rate1,c.fee,amot1a=c.amot,cprice1=c.price1,cprice2=c.price2,fee_type_id=0 ,not_amot=cast((isnull(c.amot,0)+isnull(c.fee,0))*b.qty-isnull(z.ckd_amot,0) as decimal(15,2)) 
from tb_bill a 
inner join tb_bill_dtl b on a.bod_id=b.bod_id 
left join tb_bill_stadtl h on b.dtl_id=h.dtl_id and h.agent_id>0 
left join (select c.rec_id,c.type_id,c.type_id2,agent_id=case when d.agent_id>0 then d.agent_id else c.agent_id end, 	c.rate,c.rate1,fee=case when d.fee>0 then d.fee else c.fee end,amot=case when d.agent_id>=0 then d.amot else c.amot end, 	c.price1,c.price2 from tb_busiframe3 c left join tb_busiframe3_dtl d on c.rec_id=d.rela_id) c 	 on c.rec_id=b.bf3_id and c.agent_id=case when h.agent_id>0 then h.agent_id else a.agent_id end 
inner join tb_medicine m on b.med_id=m.med_id 
left join tb_staff d on a.creat_by=d.sta_id 
left join tb_busimate e on a.dst_id=e.mate_id 
left join tb_busimate f on f.mate_id=case when h.agent_id>0 then h.agent_id else a.agent_id end 
left join tb_busiframe2 k on k.rec_id=dbo.fn_getbusiframerecid2(a.dst_id,a.agent_id,b.med_id,a.carry_dt) 
left join (select b.med_id,ckd_amot2a=sum(cast(b.amot as decimal(15,2))),  				ckd_amot1=sum(case a.bod_status_id when 1 then 1 else 0 end*cast(b.amot as decimal(15,2))) 			  from tb_bill a,tb_bill_dtl b where a.bod_type_id=37 and a.carry_dt>='2025-06-03' and a.bod_id=b.bod_id and b.type_id=1 group by b.med_id) y on y.med_id=h.rec_id 
left join (select b.med_id,ckd_amot =sum(cast(b.amot as decimal(15,2))) 			  from tb_bill a,tb_bill_dtl b where a.bod_type_id=37 and a.carry_dt>='2025-06-03' and a.bod_id=b.bod_id and b.type_id=1 				and exists (select 1 from tb_bill c,tb_bill_dtl d where c.bod_type_id=30 and c.bod_status_id=1 and c.bod_id=d.bod_id and d.med_id=a.bod_id)	group by b.med_id) z on z.med_id=h.rec_id 
left join (select ZREGIO,med_id,price10=price from tb_medprice where type_id=1) x on ZREGIO=dbo.fn_getdistrictlevel(a.district_id,1) and b.med_id=x.med_id 
where a.bod_type_id=1 and a.bod_status_id=1 and a.cate_id=2  and a.carry_dt>='2025-05-03' and a.carry_dt< dateadd(day,1,'2025-06-03')  and (b.price1>b.price) 

select * from SAP_ZSD_015 a where KDGRP not in ('10','19')  and a.carry_dt>= '2025-05-01' and a.carry_dt< dateadd(day,1,'2025-06-03')


select a.* from vi_ZSD_015 a where KDGRP not in ('10','19')  and a.carry_dt>= '2025-05-01' and a.carry_dt< dateadd(day,1,'2025-06-03')


select h.rec_id,b.dtl_id,a.bod_id,a.carry_dt,a.bod_type_id,bod_type='分销采购',  a.bod_cd,b.bod_cd1,b.bod_cd2,b.bod_cd3,a.bod_desc,a.bod_desc1,a.broker_id,broker=dbo.fn_staff_name(a.broker_id),  agent_id=case when h.agent_id>0 then h.agent_id else a.agent_id end,  agent=f.mate_name,stoppay=isnull(f.stoppay,0),	dist1=dbo.fn_getdistrictlevel (a.district_id,1),	dist2=dbo.fn_getdistrictlevel (a.district_id,2), level1=dbo.fn_obj_desc(k.level_id1),creater=d.zname,a.dst_id,e.mate_name,m.med_code,m.med_name,m.specifi,m.pdt_place,med_unit=dbo.fn_obj_desc(m.unit_id),m.type_id1,b.bat_cd, z.ckd_amot,y.ckd_amot1,a.ckd_amot2,y.ckd_amot2a,h.ckd_amot3, b.qty,b.price,b.amot,b.amot2,b.price1,x.price10, c.type_id,c.type_id2,c.rate,c.rate1,c.fee,amot1a=c.amot,cprice1=c.price1,cprice2=c.price2,fee_type_id=0 ,not_amot=cast((isnull(c.amot,0)+isnull(c.fee,0))*b.qty-isnull(z.ckd_amot,0) as decimal(15,2)) 
from tb_bill a 
inner join tb_bill_dtl b on a.bod_id=b.bod_id 
left join tb_bill_stadtl h on b.dtl_id=h.dtl_id and h.agent_id>0 
left join (select c.rec_id,c.type_id,c.type_id2,agent_id=case when d.agent_id>0 then d.agent_id else c.agent_id end, 	c.rate,c.rate1,fee=case when d.fee>0 then d.fee else c.fee end,amot=case when d.agent_id>=0 then d.amot else c.amot end, 	c.price1,c.price2 from tb_busiframe3 c left join tb_busiframe3_dtl d on c.rec_id=d.rela_id) c 	 on c.rec_id=b.bf3_id and c.agent_id=case when h.agent_id>0 then h.agent_id else a.agent_id end 
inner join tb_medicine m on b.med_id=m.med_id 
left join tb_staff d on a.creat_by=d.sta_id 
left join tb_busimate e on a.dst_id=e.mate_id 
left join tb_busimate f on f.mate_id=case when h.agent_id>0 then h.agent_id else a.agent_id end 
left join tb_busiframe2 k on k.rec_id=dbo.fn_getbusiframerecid2(a.dst_id,a.agent_id,b.med_id,a.carry_dt) 
left join (select b.med_id,ckd_amot2a=sum(cast(b.amot as decimal(15,2))),  				ckd_amot1=sum(case a.bod_status_id when 1 then 1 else 0 end*cast(b.amot as decimal(15,2))) 			  from tb_bill a,tb_bill_dtl b where a.bod_type_id=37 and a.carry_dt>='2025-06-03' and a.bod_id=b.bod_id and b.type_id=1 group by b.med_id) y on y.med_id=h.rec_id 
left join (select b.med_id,ckd_amot =sum(cast(b.amot as decimal(15,2))) 			  from tb_bill a,tb_bill_dtl b where a.bod_type_id=37 and a.carry_dt>='2025-06-03' and a.bod_id=b.bod_id and b.type_id=1 				and exists (select 1 from tb_bill c,tb_bill_dtl d where c.bod_type_id=30 and c.bod_status_id=1 and c.bod_id=d.bod_id and d.med_id=a.bod_id)	group by b.med_id) z on z.med_id=h.rec_id 
left join (select ZREGIO,med_id,price10=price from tb_medprice where type_id=1) x on ZREGIO=dbo.fn_getdistrictlevel(a.district_id,1) and b.med_id=x.med_id 
where a.bod_type_id=1 and a.bod_status_id=1 and a.cate_id=2  and a.carry_dt>='2025-05-03' and a.carry_dt< dateadd(day,1,'2025-06-03')  and (b.price1>b.price) 

select a.rec_id,dtl_id=0,bod_id=0,a.carry_dt,bod_type_id=0,bod_type='分销采购',bod_cd=GBELN,bod_cd1='',bod_cd2='',bod_cd3='',bod_desc='',bod_desc1='',
 broker_id=ZSALESID_O,broker=ZSALESNAM_O,  agent_id=ASSIGNED_BP,  agent=NAME_FIRST,stoppay=0,	
 dist1=ZZREGION,	dist2=ZCITYNAME, level1=ZBEZEI,creater=ZTERNAM,dst_id=KUNNR,mate_name=NAME1,material_code=a.MATNR,med_code='',med_name=ARKTX,specifi=ZGG,pdt_place=ZSCQY,med_unit='',type_id1=0,bat_cd=CHARG, 
 ckd_amot=0.00,ckd_amot1=0.00,ckd_amot2=0.00,ckd_amot2a=0.00,ckd_amot3=0.00, 
 a.qty,a.price,a.amot,a.amot2,price1=0.0000,price10=0.0000, 
 type_id=0,type_id2=0,rate=0.00,rate1=0.00,fee=0.00,amot1a=0.00,cprice1=0.0000,cprice2=0.0000,fee_type_id=0 ,not_amot=0.00
from SAP_ZSD_015 a where KDGRP not in ('10','19')  and a.carry_dt>= '2025-05-01' and a.carry_dt< dateadd(day,1,'2025-06-03')

select a.rec_id,dtl_id=0,bod_id=0,a.carry_dt,bod_type_id=0,bod_type='分销采购',bod_cd=GBELN,bod_cd1='',bod_cd2='',bod_cd3='',bod_desc='',bod_desc1='',  broker_id=ZSALESID_O,broker=ZSALESNAM_O,  agent_id=ASSIGNED_BP,  agent=NAME_FIRST,stoppay=0, dist1=ZZREGION,	dist2=ZCITYNAME, level1=ZBEZEI,creater=ZTERNAM,dst_id=cast(KUNNR as int),mate_name=NAME1,material_code=a.MATNR,med_code='',med_name=ARKTX,specifi=ZGG,pdt_place=ZSCQY,med_unit='',type_id1=0,bat_cd=CHARG, ckd_amot=0.00,ckd_amot1=0.00,ckd_amot2=0.00,ckd_amot2a=0.00,ckd_amot3=0.00, a.qty,a.price,a.amot,a.amot1,a.amot2,price1=0.0000,price10=0.0000, type_id=0,type_id2=0,rate=0.00,rate1=0.00,fee=0.00,amot1a=0.00,cprice1=0.0000,cprice2=0.0000,fee_type_id=0 ,not_amot=0.00 
from SAP_ZSD_015 a 
where KDGRP not in ('10','19')  and a.carry_dt>='2025-03-03' and a.carry_dt< dateadd(day,1,'2025-06-03')

select top 10 * from SAP_ZSD_015


declare @tab table (line_no varchar(3),f1 varchar(100),f2 varchar(100),f3 varchar(100),f4 varchar(100),f5 varchar(100),f6 varchar(100),f7 varchar(100),f8 varchar(100),f9 varchar(100)) 
insert into @tab (line_no,f1,f2,f3,f4,f5,f6,f7,f8,f9) 
select 2,'10','10','安徽省','','1000010000','28.02','10.6476','1','2025-1-1' union all  select 3,'10','10','北京市','','1000002400','22.05','9.9225','1','2025-1-1' union all  select 4,'10','10','北京市','','1000043400','44.10','19.8450','1','2025-1-1' union all  select 5,'10','12','北京市','','1000016900','28.00','0.5000','1','2025-1-1' union all  select 6,'10','10','北京市','','1000010000','28.02','11.2080','1','2025-1-1' union all  select 7,'10','10','北京市','','1000018900','8.27','2.4810','1','2025-1-1' union all  select 8,'10','10','甘肃省','','1000016700','29.88','5.0000','1','2025-1-1' union all  select 9,'10','12','广东省','','1000001900','4.80','0.2250','1','2025-1-1' union all  select 10,'10','10','广东省','','1000002100','33.00','15.8400','1','2025-1-1' union all  select 11,'10','10','广东省','','1000015900','3.33','0.3330','1','2025-1-1' union all  select 12,'10','10','广东省','','1000002400','22.05','9.2610','1','2025-1-1' union all  select 13,'10','10','广东省','','1000016000','61.80','29.6640','1','2025-1-1' union all  select 14,'10','10','广东省','','1000016200','59.20','23.6800','1','2025-1-1' union all  select 15,'10','10','广东省','','1000004100','36.30','14.5200','1','2025-1-1' union all  select 16,'10','10','广东省','','1000004400','49.20','23.6160','1','2025-1-1' union all  select 17,'10','10','广东省','','1000004900','59.40','27.3240','1','2025-1-1' union all  select 18,'10','12','广东省','','1000025800','11.00','2.0000','1','2025-1-1' union all  select 19,'10','12','广东省','','1000026000','14.39','0.3000','1','2025-1-1' union all  select 20,'10','10','广东省','','1000016700','38.50','5.0000','1','2025-1-1' union all  select 21,'10','12','广东省','','1000016900','28.00','0.5000','1','2025-1-1' union all  select 22,'10','10','广东省','','1000005600','22.22','7.9992','1','2025-1-1' union all  select 23,'10','10','广东省','','1000017000','78.00','31.2000','1','2025-1-1' union all  select 24,'10','10','广东省','','1000027700','22.68','8.1648','1','2025-1-1' union all  select 25,'10','10','广东省','','1000017400','78.00','31.2000','1','2025-1-1' union all  select 26,'10','10','广东省','','1000017200','39.00','15.6000','1','2025-1-1' union all  select 27,'10','10','广东省','','1000017500','47.88','22.9824','1','2025-1-1' union all  select 28,'10','10','广东省','','1000008100','45.00','21.6000','1','2025-1-1' union all  select 29,'10','10','广东省','','1000008000','30.00','14.4000','1','2025-1-1' union all  select 30,'10','10','广东省','','1000008800','23.10','2.3100','1','2025-1-1' union all  select 31,'10','10','广东省','','1000008600','12.50','1.8750','1','2025-1-1' union all  select 32,'10','10','广东省','','1000017800','49.50','23.7600','1','2025-1-1' union all  select 33,'10','10','广东省','','1000018000','1.88','0.1880','1','2025-1-1' union all  select 34,'10','12','广东省','','1000018100','98.50','15.2100','1','2025-1-1' union all  select 35,'10','10','广东省','','1000018200','29.70','13.3650','1','2025-1-1' union all  select 36,'10','10','广东省','','1000018300','0.36','0.0360','1','2025-1-1' union all  select 37,'10','12','广东省','','1000010300','15.95','6.3590','1','2025-1-1' union all  select 38,'10','10','广东省','','1000009800','18.96','6.6360','1','2025-1-1' union all  select 39,'10','10','广东省','','1000010000','28.02','9.8070','1','2025-1-1' union all  select 40,'10','10','广东省','','1000018400','33.05','13.2200','1','2025-1-1' union all  select 41,'10','10','广东省','','1000018700','27.77','11.6634','1','2025-1-1' union all  select 42,'10','10','广东省','','1000019100','79.76','31.9040','1','2025-1-1' union all  select 43,'10','10','广东省','','1000019200','46.91','18.7640','1','2025-1-1' union all  select 44,'10','10','广东省','','1000011400','49.80','23.9040','1','2025-1-1' union all  select 45,'10','10','广东省','','1000011500','45.00','21.6000','1','2025-1-1' union all  select 46,'10','10','广东省','','1000019500','59.29','27.8663','1','2025-1-1' union all  select 47,'10','12','广东省','','1000039900','173.47','66.1413','1','2025-1-1' union all  select 48,'10','10','广东省','','1000011900','39.53','18.5791','1','2025-1-1' union all  select 49,'10','10','广东省','','1000019600','45.00','21.6000','1','2025-1-1' union all  select 50,'10','10','广东省','','1000012500','30.00','14.4000','1','2025-1-1' union all  select 51,'10','10','广东省','','1000019700','0.83','0.0830','1','2025-1-1' union all  select 52,'10','10','广东省','','1000013000','22.00','10.5600','1','2025-1-1' union all  select 53,'10','10','广东省','','1000013100','44.00','22.0000','1','2025-1-1' union all  select 54,'10','10','广东省','','1000020100','17.85','8.9250','1','2025-1-1' union all  select 55,'10','10','广东省','','1000020200','16.33','6.8586','1','2025-1-1' union all  select 56,'10','10','广东省','','1000020400','27.58','13.2384','1','2025-1-1' union all  select 57,'10','10','广东省','','1000020500','4.23','1.3536','1','2025-1-1' union all  select 58,'10','12','广东省','','1000025900','13.80','0.8000','1','2025-1-1' union all  select 59,'10','10','广西壮族自治区','','1000001400','1.78','0.1780','1','2025-1-1' union all  select 60,'10','10','海南省','','1000010000','28.02','10.6476','1','2025-1-1' union all  select 61,'10','10','河北省','','1000008200','0.78','0.0780','1','2025-1-1' union all  select 62,'10','12','河北省','','1000009900','25.87','9.4197','1','2025-1-1' union all  select 63,'10','10','河南省','','1000002400','22.05','9.9225','1','2025-1-1' union all  select 64,'10','10','河南省','','1000043400','44.10','19.8450','1','2025-1-1' union all  select 65,'10','10','河南省','','1000016200','59.20','26.6400','1','2025-1-1' union all  select 66,'10','10','河南省','','1000017400','78.00','35.1000','1','2025-1-1' union all  select 67,'10','10','河南省','','1000010000','28.02','10.6476','1','2025-1-1' union all  select 68,'10','10','湖北省','','1000016700','29.88','5.0000','1','2025-1-1' union all  select 69,'10','10','湖北省','','1000008200','0.78','0.0780','1','2025-1-1' union all  select 70,'10','10','湖北省','','1000018000','1.88','0.1880','1','2025-1-1' union all  select 71,'10','10','湖南省','','1000010000','28.02','10.6476','1','2025-1-1' union all  select 72,'10','10','湖南省','','1000010100','36.97','14.0486','1','2025-1-1' union all  select 73,'10','10','吉林省','','1000010000','28.02','10.6476','1','2025-1-1' union all  select 74,'10','10','江苏省','','1000008200','0.78','0.0780','1','2025-1-1' union all  select 75,'10','10','江西省','','1000016700','29.88','5.0000','1','2025-1-1' union all  select 76,'10','10','江西省','','1000008800','4.27','0.4270','1','2025-1-1' union all  select 77,'10','10','江西省','','1000010000','28.02','10.6476','1','2025-1-1' union all  select 78,'10','10','辽宁省','','1000010000','28.02','10.6476','1','2025-1-1' union all  select 79,'10','10','辽宁省','','1000019600','45.00','21.6000','1','2025-1-1' union all  select 80,'10','12','宁夏回族自治区','','1000016900','28.00','0.5000','1','2025-1-1' union all  select 81,'10','10','宁夏回族自治区','','1000008200','0.78','0.0780','1','2025-1-1' union all  select 82,'10','10','山东省','','1000002200','58.00','27.8400','1','2025-1-1' union all  select 83,'10','10','山东省','','1000010000','28.02','10.6476','1','2025-1-1' union all  select 84,'10','10','山东省','','1000019500','59.29','26.6805','1','2025-1-1' union all  select 85,'10','10','陕西省','','1000016700','29.88','5.0000','1','2025-1-1' union all  select 86,'10','10','上海市','','1000002000','78.00','45.2400','1','2025-1-1' union all  select 87,'10','10','上海市','','1000043400','44.10','19.8450','1','2025-1-1' union all  select 88,'10','10','上海市','','1000016700','19.93','2.9895','1','2025-1-1' union all  select 89,'10','10','上海市','','1000018200','49.30','27.1150','1','2025-1-1' union all  select 90,'10','10','上海市','','1000009800','18.96','7.2048','1','2025-1-1' union all  select 91,'10','10','上海市','','1000010000','28.02','11.2080','1','2025-1-1' union all  select 92,'10','10','上海市','','1000018400','57.30','25.7850','1','2025-1-1' union all  select 93,'10','12','四川省','','1000016900','28.00','0.5000','1','2025-1-1' union all  select 94,'10','10','四川省','','1000010000','28.02','10.6476','1','2025-1-1' union all  select 95,'10','10','四川省','','1000019700','0.83','0.0830','1','2025-1-1' union all  select 96,'10','10','天津市','','1000001400','1.78','0.1780','1','2025-1-1' union all  select 97,'10','10','天津市','','1000016700','29.88','5.0000','1','2025-1-1' union all  select 98,'10','10','云南省','','1000010000','28.02','10.6476','1','2025-1-1' union all  select 99,'10','10','云南省','','1000019700','0.83','0.0830','1','2025-1-1' union all  select 100,'10','10','云南省','','1000013300','76.60','11.4900','1','2025-1-1' union all  select 101,'10','10','浙江省','','1000010000','28.02','9.8070','1','2025-1-1' union all  select 102,'10','10','重庆市','','1000010000','28.02','10.6476','1','2025-1-1' union all  select 103,'10','10','内蒙古自治区','','1000015900','3.33','0.3330','1','2025-1-1' union all  select 104,'10','10','内蒙古自治区','','1000016700','29.88','5.0000','1','2025-1-1' union all  select 105,'10','10','新疆维吾尔自治区','','1000010000','28.02','10.6476','1','2025-1-1' union all  select 106,'10','10','新疆维吾尔自治区','','1000019700','0.83','0.0830','1','2025-1-1' 
select count(1) from @tab

insert into tb_medprice (comp_id,type_id,channel_id,channel_dtl_id,district_id,med_id,price,price_unit,price1,valid_from,creat_by,creat_dt)  
select comp_id=1,type_id=3,channel_id=b.obj_id,channel_dtl_id=c.obj_id,district_id=case when e.city_code<>'' then e.city_code else d.prov_code end,      m.med_id,price=f7,price_unit=f8,price1=f6,valid_from=cast(f9 as datetime),      creat_by=19273,creat_dt=getdate() 
from @tab a 
left join tb_object b on b.obj_type_id=11 and b.obj_code= a.f1 
left join tb_object c on c.obj_type_id=12 and c.obj_code= a.f2 
left join (select distinct prov_code,prov_name from tb_district where prov_name<>'') d on d.prov_name= a.f3 
left join (select distinct city_code,city_name from tb_district where city_name<>'') e on e.city_name= a.f4 
left join tb_medicine m on m.material_code1=a.f5 

select @@ROWCOUNT
